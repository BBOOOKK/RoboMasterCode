# 参数调优指南

本指南提供详细的参数调优说明，帮助您实现最佳的巡线性能。

## 目录
1. [颜色检测参数](#颜色检测参数)
2. [PID控制器调优](#pid控制器调优)
3. [速度设置](#速度设置)
4. [恢复参数](#恢复参数)
5. [调优工作流程](#调优工作流程)

## 颜色检测参数

### HSV阈值 (`color_detection`)
- **下限蓝色**: `[100, 80, 50]`
- **上限蓝色**: `[130, 255, 255]`

**调优技巧:**
1. **色调 (H)**: 100-130 覆盖大多数蓝色色调
   - 如果漏检浅蓝色，降低下限
   - 如果漏检深蓝色，提高上限
2. **饱和度 (S)**: 80-255 排除低饱和度噪声
   - 在光线较差时降低最小饱和度
3. **明度 (V)**: 50-255 处理各种亮度级别
   - 根据光照条件调整

**测试方法:**
- 运行程序并显示调试窗口
- 观察"掩膜"窗口 - 应显示黑色背景上的清晰白线
- 调整阈值直到只有赛道线可见

## PID控制器调优

### 主PID (直线段)
- **P**: 0.2 - 比例增益
- **I**: 0.001 - 积分增益  
- **D**: 0.05 - 微分增益
- **输出限制**: 80 - 最大输出

### 曲线PID (曲线段)
- **P**: 0.5 - 更高增益用于激进转向
- **I**: 0.002 - 稍高的积分增益
- **D**: 0.08 - 更多的微分作用
- **输出限制**: 100 - 更高限制用于急转弯

**调优策略:**

1. **仅使用P项** (设置I=0, D=0)
   - 增加P直到机器人振荡，然后减少50%
2. **添加D项** 以减少振荡
   - 从 D = P / 4 开始
   - 如果仍有超调，增加D值
3. **添加I项** 以消除稳态误差
   - 从非常小的I值开始 (0.001)
   - 如果机器人偏离中心，缓慢增加I值

**曲率阈值:**
- **进入**: 0.3 - 高于此值切换到曲线PID
- **退出**: 0.2 - 低于此值返回主PID
- 迟滞防止模式快速切换

## 速度设置

### 基础速度
- **直线**: 0.82 - 直线段的较快速度
- **曲线**: 0.58 - 曲线段的较慢速度，便于转向

**调优技巧:**
1. 从保守速度开始 (0.5-0.7)
2. 增加直线速度直到出现稳定性问题
3. 曲线速度应比直线速度慢20-30%
4. 考虑赛道复杂性 - 更紧的曲线需要更慢的速度

## 恢复参数

### 丢线恢复
- **最大丢帧数**: 10 - 开始搜索前的帧数
- **搜索超时**: 8.0秒 - 改变方向前的超时时间
- **搜索速度**: 20.0°/秒 - 搜索期间的旋转速度

**调优技巧:**
1. **最大丢帧数**: 
   - 更高 = 对临时障碍更容忍
   - 更低 = 对实际丢线响应更快
2. **搜索超时**:
   - 根据赛道布局复杂性调整
   - 简单赛道使用更长超时
3. **搜索速度**:
   - 较慢用于精确查找
   - 较快用于快速恢复

## 调优工作流程

### 阶段1: 基础设置
1. 验证颜色检测正常工作
2. 设置保守速度 (0.5-0.6)
3. 开始仅使用P控制

### 阶段2: 直线调优
1. 在直线段调优主PID
2. 专注于最小化振荡
3. 验证中心跟踪准确性

### 阶段3: 曲线处理
1. 在各种曲线半径上测试
2. 调优曲线PID参数
3. 调整曲率阈值

### 阶段4: 速度优化
1. 逐渐增加直线速度
2. 保持曲线速度比例
3. 测试高速下的恢复能力

### 阶段5: 恢复调优
1. 测试丢线场景
2. 调整搜索参数
3. 验证可靠的恢复能力

## 常见问题及解决方案

### 问题: 机器人在直线段振荡
**解决方案**: 减少P增益，增加D增益

### 问题: 机器人偏离中心
**解决方案**: 稍微增加I增益

### 问题: 曲线跟踪不良
**解决方案**: 增加曲线P增益，降低曲线速度

### 问题: 错误线条检测
**解决方案**: 调整HSV阈值，检查光照

### 问题: 丢线恢复缓慢
**解决方案**: 减少搜索超时，增加搜索速度

## 性能指标

调优期间跟踪这些指标:
- **平均速度**: 整体赛道完成时间
- **跟踪误差**: 偏离中心的平均偏差
- **恢复时间**: 重新获取线条的时间
- **成功率**: 完成圈数的百分比

记住: 小而渐进的更改和彻底测试是成功参数调优的关键!
