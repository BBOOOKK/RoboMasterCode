# RoboMaster S1 转弯逻辑详细分析

## 转弯控制整体架构

### 1. 检测阶段
**图像处理流程**：
1. **颜色检测**：通过HSV颜色空间创建蓝色掩膜
2. **形态学处理**：使用闭运算和开运算去除噪声
3. **ROI检测**：在多个预设行位置检测蓝线中心点
4. **未来预测**：提取最前方的3个点进行弯道预测

### 2. 决策阶段
**转弯判断逻辑**：
```python
# 根据曲率选择控制模式
use_curve_pid = abs(self.avg_curvature) > self.config.curvature_enter_threshold

if use_curve_pid:
    # 弯道模式：使用更强的弯道PID控制器
    z_speed = self.curved_pid.update(0, error)
    x_speed = self._calculate_curve_speed(curvature, self.config.base_speed_curve)
else:
    # 直线模式：使用主PID控制器  
    z_speed = self.main_pid.update(0, error)
    x_speed = base_speed
```

## 核心转弯算法详解

### 1. 曲率计算 (`calculate_curvature`)
**算法原理**：
- 使用二次多项式拟合检测到的点：`x = a*y² + b*y + c`
- 曲率近似计算：`k ≈ |2a|`
- 曲率值越大表示弯道越急

**数学公式**：
```
曲率 k = |2 * 二次项系数a|
```

### 2. 方向判断 (`get_curve_direction`)
**算法原理**：
- 使用线性回归拟合：`x = m*y + b`
- 根据斜率m判断方向：
  - `m < -0.1`：向左转弯（负斜率）
  - `m > 0.1`：向右转弯（正斜率）  
  - 否则：直行

### 3. 弯道减速策略 (`_calculate_curve_speed`)
**减速算法**：
```python
speed_reduction = min(0.8, curvature * 2.0)  # 最大减速80%
return base_speed * (1.0 - speed_reduction)
```
- 曲率越大，减速越多
- 最大减速限制为80%

### 4. 未来预测 (`_predict_future_curvature`)
**预测逻辑**：
1. 提取画面最前方的3个检测点
2. 计算这些点的曲率作为未来曲率
3. 如果未来曲率超过阈值，提前减速准备入弯

## PID控制器配置

### 主PID控制器（直线模式）
```python
main_pid_params = (0.7, 0.0010, 0.20, 170)  # (P, I, D, 输出限制)
```
- **P=0.7**：中等比例增益，保证直线稳定性
- **I=0.0010**：较小的积分项，消除稳态误差
- **D=0.20**：适当的微分项，抑制超调

### 弯道PID控制器（弯道模式）
```python
curved_pid_params = (3.0, 0.0015, 0.55, 300)  # (P, I, D, 输出限制)
```
- **P=3.0**：很强的比例增益，快速响应弯道
- **I=0.0015**：积分项略大，适应弯道持续误差
- **D=0.55**：较大的微分项，防止弯道过冲

## 转弯状态机

### 状态转换条件：
1. **直线 → 弯道**：`avg_curvature > curvature_enter_threshold (0.05)`
2. **弯道 → 直线**：`avg_curvature < curvature_exit_threshold (0.04)`
3. **丢线状态**：连续10帧未检测到线条

### 弯道模式特性：
- 使用更强的PID参数（3倍于直线模式）
- 根据曲率线性减速（最大减速80%）
- 记录最后一次弯道方向用于丢线恢复

## 丢线恢复策略

### 增强搜索逻辑：
```python
if self.last_curve_direction != "straight":
    if self.last_curve_direction == "left":
        search_speed = search_speed_degrees * 1.8  # 左转加强
    else:
        search_speed = search_speed_degrees * -1.8  # 右转加强
```
- 基于最后一次弯道方向进行强力转向
- 左转丢失则加强左转搜索，右转丢失则加强右转搜索

## 参数调优指南

### 竞速型调优：
1. **提高P值**：增加转向响应速度
2. **降低曲率阈值**：更早检测弯道  
3. **提高基础速度**：但需相应调整减速策略
4. **减少历史数据长度**：提高响应速度但降低稳定性

### 稳定型调优：
1. **降低P值**：减少过冲和震荡
2. **提高曲率阈值**：减少误判
3. **增加历史数据**：平滑控制输出
4. **加强弯道减速**：确保过弯安全

## 调试技巧

### 实时监控参数：
- **误差**：中心点偏移量，理想值为0
- **曲率**：弯道急缓程度，>0.05进入弯道模式
- **X速度**：前进速度，弯道时会减速
- **Z速度**：转向速度，正值右转，负值左转

### 常见问题解决：
- **转向不足**：提高弯道P值或降低曲率阈值
- **转向过度**：降低弯道P值或增加微分项
- **震荡严重**：增加历史数据平滑或降低P值
- **响应迟钝**：减少历史数据或提高P值

这个转弯逻辑系统通过多层次的检测、预测和控制策略，实现了从温和到激进的平滑转弯控制，适应不同的竞赛需求。
