import cv2
import time
import os
import numpy as np
from datetime import datetime
from robomaster import robot, vision, gimbal

# Configuration constants
IMAGE_WIDTH = 1280
IMAGE_HEIGHT = 720
TARGET_NUMBERS = {'1', '2', '3', '4', '5'}
YELLOW_COLOR = (0, 255, 255)  # BGR format
BLACK_COLOR = (0, 0, 0)
GREEN_COLOR = (0, 255, 0)

class MarkerInfo:
    def __init__(self, x, y, w, h, info):
        self._x = x
        self._y = y
        self._w = w
        self._h = h
        self._info = info

    @property
    def pt1(self):
        return int((self._x - self._w / 2) * IMAGE_WIDTH), int((self._y - self._h / 2) * IMAGE_HEIGHT)

    @property
    def pt2(self):
        return int((self._x + self._w / 2) * IMAGE_WIDTH), int((self._y + self._h / 2) * IMAGE_HEIGHT)

    @property
    def center(self):
        return int(self._x * IMAGE_WIDTH), int(self._y * IMAGE_HEIGHT)

    @property
    def text(self):
        return self._info

# Global state
markers = []
recognized_numbers = set()
numbers_to_save = set()
total_saves = 0
gimbal_moving = False
target_number = None

# ===== æ–°å¢ï¼šæ‹ç…§ä¼šè¯ç›¸å…³å…¨å±€å˜é‡ =====
photo_session_active = False      # æ˜¯å¦æ­£åœ¨è¿›è¡Œâ€œä¾æ¬¡æ‹ 1~5â€çš„ä¼šè¯
scan_queue = []                   # æœ¬æ¬¡ä¼šè¯è¦æ‹çš„æ•°å­—é˜Ÿåˆ—ï¼ˆåªå«å½“å‰ç”»é¢é‡ŒçœŸçš„å‡ºç°çš„ï¼‰
newly_recognized_in_frame = []    # æœ¬å¸§æ–°è¯†åˆ«åˆ°çš„æ•°å­—ï¼ˆç”¨äºè§¦å‘ä¼šè¯ï¼Œé¿å…åå¤è§¦å‘ï¼‰
target_deadline = 0.0             # å½“å‰ç›®æ ‡çš„è¶…æ—¶æˆªæ­¢ï¼ˆæ‰¾ä¸åˆ°å°±è·³è¿‡ï¼‰

def on_detect_marker(marker_info):
    """Callback function for marker detection"""
    global markers, recognized_numbers, numbers_to_save, target_number, gimbal_moving
    # ===== æ–°å¢ï¼šéœ€è¦è¯»å–æ‹ç…§ä¼šè¯å¼€å…³ï¼Œé¿å…ä¸ä¼šè¯æŠ¢äº‘å° =====
    global photo_session_active, newly_recognized_in_frame

    markers.clear()
    detected_numbers = []
    newly_recognized_in_frame.clear()  # æ¯æ¬¡å›è°ƒåˆ·æ–°

    for i in range(len(marker_info)):
        x, y, w, h, info = marker_info[i]
        markers.append(MarkerInfo(x, y, w, h, info))

        # Process target numbers
        if info in TARGET_NUMBERS:
            num = int(info)
            detected_numbers.append((num, x, y))

            if num not in recognized_numbers:
                recognized_numbers.add(num)
                numbers_to_save.add(num)
                newly_recognized_in_frame.append(num)   # ===== æ–°å¢ï¼šè®°å½•â€œæ–°å‡ºç°â€çš„æ•°å­—
                print(f"âœ… Recognized new number: {num}")

    # Auto-select target for gimbal trackingï¼ˆä¸åœ¨æ‹ç…§ä¼šè¯æ—¶æ‰è‡ªåŠ¨æŒ‘ç›®æ ‡ï¼‰
    if detected_numbers and (not gimbal_moving) and (not photo_session_active):
        # æ‰¾æœ€å±…ä¸­çš„
        best_target = min(detected_numbers, key=lambda item: abs(item[1] - 0.5) + abs(item[2] - 0.5))
        target_num, target_x, target_y = best_target
        # è®¾ä¸ºå½“å‰è‡ªåŠ¨è·Ÿè¸ªç›®æ ‡
        target_number = target_num
        gimbal_moving = True
        print(f"ğŸ¯ Gimbal targeting number {target_number} at position ({target_x:.2f}, {target_y:.2f})")

def save_number_image(img, number):
    """Save annotated image with recognized number"""
    try:
        os.makedirs("recognized_numbers", exist_ok=True)
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"recognized_numbers/number_{number}_{timestamp}.jpg"
        cv2.imwrite(filename, img)
        print(f"ğŸ’¾ Saved annotated image: {filename}")
        return filename
    except Exception as e:
        print(f"âŒ Error saving image: {e}")
        return None

def draw_annotations(image, markers_list):
    """Draw annotations on the image"""
    for marker in markers_list:
        box_color = GREEN_COLOR if str(target_number) == marker.text else YELLOW_COLOR
        cv2.rectangle(image, marker.pt1, marker.pt2, box_color, 3)

        label = f"Number: {marker.text}"
        text_size = cv2.getTextSize(label, cv2.FONT_HERSHEY_SIMPLEX, 0.8, 2)[0]
        text_x = marker.center[0] - text_size[0] // 2
        text_y = marker.pt1[1] - 10 if marker.pt1[1] > 30 else marker.pt2[1] + 30

        cv2.rectangle(image, (text_x - 5, text_y - text_size[1] - 5),
                      (text_x + text_size[0] + 5, text_y + 5), box_color, -1)
        cv2.putText(image, label, (text_x, text_y), cv2.FONT_HERSHEY_SIMPLEX, 0.8, BLACK_COLOR, 2)

        if marker.text in [str(n) for n in recognized_numbers]:
            marker_size = 12
            marker_x = text_x - marker_size - 8
            marker_y = text_y
            cv2.putText(image, "âœ“", (marker_x, marker_y), cv2.FONT_HERSHEY_SIMPLEX, 0.8, BLACK_COLOR, 2)

    return image

def move_gimbal_to_target(ep_gimbal, target_x, target_y):
    """Move gimbal to center the target in the view"""
    global gimbal_moving

    x_offset = target_x - 0.5
    y_offset = target_y - 0.5

    # è§†åœºè§’è¿‘ä¼¼ï¼ˆæ°´å¹³60Â°ã€å‚ç›´45Â°ï¼‰ï¼ŒæŠŠåƒé¢åå·®è½¬æˆè§’åº¦å¾®è°ƒ
    yaw_offset = -x_offset * 30.0
    pitch_offset = -y_offset * 22.5

    ep_gimbal.move(yaw=yaw_offset, pitch=pitch_offset).wait_for_completed()

    if abs(x_offset) < 0.1 and abs(y_offset) < 0.1:
        gimbal_moving = False
        print(f"ğŸ¯ Number {target_number} centered by gimbal movement")
        return True
    return False

# ===== æ–°å¢ï¼šåº•ç›˜æš‚åœ/æ¢å¤ï¼ˆä¸ç ´åä½ åŸæœ‰è¡Œé©¶é€»è¾‘ï¼Œåªåœ¨ä¼šè¯æ—¶å‘â€œåœâ€ï¼‰=====
def pause_chassis(ep_robot):
    ch = getattr(ep_robot, 'chassis', None)
    if ch is None:
        return
    try:
        # è¿ç»­é€Ÿåº¦æ§åˆ¶ï¼šç½®é›¶
        ch.drive_speed(x=0, y=0, z=0)
    except Exception:
        pass
    try:
        # è‹¥åœ¨æ‰§è¡Œ move ä»»åŠ¡ï¼Œå‘é€ stop
        ch.stop()
    except Exception:
        pass

if __name__ == '__main__':
    # Initialize RoboMaster robot
    ep_robot = robot.Robot()
    ep_robot.initialize(conn_type="ap")

    ep_vision = ep_robot.vision
    ep_camera = ep_robot.camera
    ep_gimbal = ep_robot.gimbal
    ep_chassis = ep_robot.chassis  # ===== æ–°å¢ï¼šæ‹¿åˆ°åº•ç›˜å¥æŸ„ï¼ˆç”¨äºæš‚åœï¼‰

    # Start video stream and marker detection
    ep_camera.start_video_stream(display=False)
    ep_vision.sub_detect_info(name="marker", callback=on_detect_marker)

    # Set gimbal mode and recenter
    ep_gimbal.recenter().wait_for_completed()

    print("ğŸš€ Number recognition system started")
    print("ğŸ“‹ Target numbers: 1, 2, 3, 4, 5")
    print("ğŸ“· Gimbal auto-tracking enabled")
    print("â¹ï¸  Press 'q' to quit")

    time.sleep(1)

    try:
        while True:
            img = ep_camera.read_cv2_image(strategy="newest", timeout=0.5)
            if img is None:
                continue

            # ===== æ–°å¢ï¼šè‹¥æœ¬å¸§å‡ºç°äº†æ–°çš„ 1~5ï¼Œè§¦å‘ä¸€æ¬¡â€œæ‹ç…§ä¼šè¯â€ =====
            if (not photo_session_active) and newly_recognized_in_frame:
                # åªå–å½“å‰ç”»é¢é‡Œå®é™…å‡ºç°çš„ 1~5ï¼ŒæŒ‰æ•°å­—é¡ºåºæ’é˜Ÿ
                present = sorted({int(m.text) for m in markers if m.text in TARGET_NUMBERS})
                if present:
                    pause_chassis(ep_robot)     # å…ˆè®©è½¦åœ
                    photo_session_active = True
                    scan_queue = present.copy()
                    print(f"ğŸ“· Photo session started. Queue = {scan_queue}")
                newly_recognized_in_frame.clear()

            # ===== æ–°å¢ï¼šä¼šè¯çŠ¶æ€æœºâ€”â€”ä¾æ¬¡æŠŠäº‘å°å¯¹å‡†é˜Ÿåˆ—ä¸­çš„æ•°å­—å¹¶æ‹ç…§ =====
            if photo_session_active:
                # è‹¥å½“å‰æ²¡æœ‰åœ¨åŠ¨äº‘å°ï¼Œå®‰æ’ä¸‹ä¸€ä¸ªç›®æ ‡
                if not gimbal_moving:
                    if target_number is not None:
                        # ä¸Šä¸€ä¸ªç›®æ ‡å·²å®Œæˆå¯¹ä¸­ä¸æ‹ç…§
                        target_number = None
                    if scan_queue:
                        next_num = scan_queue.pop(0)
                        target_number = next_num
                        gimbal_moving = True
                        target_deadline = time.time() + 2.0  # å•ä¸ªç›®æ ‡æœ€å¤šç­‰2ç§’ï¼ˆé˜²æ­¢ç›®æ ‡çªç„¶æ¶ˆå¤±å¡æ­»ï¼‰
                        print(f"â¡ï¸  Scanning number {next_num} ...")
                    else:
                        # é˜Ÿåˆ—ç©ºï¼šä¼šè¯ç»“æŸï¼Œäº‘å°å›æ­£
                        ep_gimbal.recenter().wait_for_completed()
                        photo_session_active = False
                        print("âœ… Photo session finished. Resume driving by your control loop.")
                else:
                    # æ­£åœ¨ç­‰å¾…åŸæœ‰åˆ†æ”¯å®Œæˆå¯¹ä¸­ä¸æ‹ç…§ï¼›å¦‚æœç›®æ ‡ä¸åœ¨ç”»é¢é‡Œä¸”è¶…æ—¶ï¼Œåˆ™è·³è¿‡
                    target_exists = any(m.text == str(target_number) for m in markers)
                    if (not target_exists) and (time.time() > target_deadline):
                        print(f"â­ï¸  Number {target_number} missing, skip.")
                        gimbal_moving = False  # è·³è¿‡æœ¬ç›®æ ‡ï¼Œå»å®‰æ’ä¸‹ä¸€ä¸ª

            # ===== åŸæœ‰ï¼šè‡ªåŠ¨è·Ÿéšä¸æ‹ç…§ï¼ˆä¿æŒä¸åŠ¨ï¼‰=====
            if gimbal_moving and target_number is not None:
                target_marker = None
                for marker in markers:
                    if marker.text == str(target_number):
                        target_marker = marker
                        break

                if target_marker:
                    norm_x = target_marker._x
                    norm_y = target_marker._y

                    if move_gimbal_to_target(ep_gimbal, norm_x, norm_y):
                        annotated_img = img.copy()
                        annotated_img = draw_annotations(annotated_img, markers)
                        filename = save_number_image(annotated_img, target_number)
                        if filename:
                            total_saves += 1
                            print(f"ğŸ“¸ Gimbal centered and saved number {target_number}")

            # åŸæœ‰ï¼šå…¶å®ƒå·²è¯†åˆ«æ•°å­—çš„â€œéè·Ÿè¸ªä¿å­˜â€
            if numbers_to_save:
                for num in list(numbers_to_save):
                    if num != target_number:  # é¿å…é‡å¤ä¿å­˜æ­£åœ¨è·Ÿè¸ªçš„è¿™ä¸ª
                        annotated_img = img.copy()
                        annotated_img = draw_annotations(annotated_img, markers)
                        filename = save_number_image(annotated_img, num)
                        if filename:
                            total_saves += 1
                            print(f"ğŸ“¸ Saved number {num}")
                numbers_to_save.clear()

            # å åŠ æ˜¾ç¤º
            display_img = img.copy()
            display_img = draw_annotations(display_img, markers)
            stats_text = f"Recognized: {sorted(recognized_numbers)} | Saves: {total_saves}"
            cv2.putText(display_img, stats_text, (10, 30), cv2.FONT_HERSHEY_SIMPLEX, 0.7, GREEN_COLOR, 2)
            cv2.imshow("Number Recognition System", display_img)

            if cv2.waitKey(1) & 0xFF == ord('q'):
                print("ğŸ›‘ Stopping recognition system...")
                break

    except KeyboardInterrupt:
        print("ğŸ›‘ Program interrupted by user")
    except Exception as e:
        print(f"âŒ Unexpected error: {e}")
    finally:
        print("ğŸ§¹ Cleaning up resources...")
        ep_vision.unsub_detect_info(name="marker")
        ep_camera.stop_video_stream()
        ep_robot.close()
        cv2.destroyAllWindows()
        print("âœ… Cleanup completed")
